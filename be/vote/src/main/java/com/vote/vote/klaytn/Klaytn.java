package com.vote.vote.klaytn;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import com.klaytn.caver.Caver;
import com.klaytn.caver.crpyto.KlayCredentials;
import com.klaytn.caver.fee.FeePayerManager;
import com.klaytn.caver.methods.response.KlayTransactionReceipt;
import com.klaytn.caver.tx.gas.DefaultGasProvider;
import com.klaytn.caver.tx.manager.TransactionManager;
import com.klaytn.caver.tx.model.SmartContractDeployTransaction;
import com.klaytn.caver.tx.model.SmartContractExecutionTransaction;
import com.klaytn.caver.utils.ChainId;
import com.vote.vote.klaytn.smartContract.RIROVote3;
import com.vote.vote.klaytn.smartContract.Test6;

// import org.springframework.boot.configurationprocessor.json.JSONObject;
import org.json.simple.JSONObject;
import org.web3j.abi.FunctionEncoder;
import org.web3j.abi.datatypes.Function;
import org.web3j.abi.datatypes.generated.Uint256;
import org.web3j.protocol.core.RemoteCall;
import org.web3j.tuples.generated.Tuple9;
import org.web3j.utils.Numeric;

import org.json.simple.JSONArray;




//import org.web3j.rlp.*;
public class Klaytn {

	
	public JSONObject klaytnDeploy3() throws Exception{
		String sendUser = "0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0"; 
	
		String feeUser = "0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2"; 
		// 수수료 부담하는 사람  Private Key
	
		// 스마트컨트랙트 정보
		String data= "60806040526001805560006002556003805534801561001d57600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600181905550611424806100756000396000f3fe6080604052600436106100f35760003560e01c80639bd575c21161008a578063b5aa89eb11610059578063b5aa89eb1461036a578063d0e30db01461039d578063de8fa431146103a7578063e9ab77e5146103d2576100f3565b80639bd575c2146102a7578063a87d942c146102d3578063a998590c146102fe578063b36d8a9f1461032d576100f3565b806322434836116100c657806322434836146101d757806331841c231461021457806350c42c78146102515780638da5cb5b1461027c576100f3565b806312065fe0146100f557806312514bba14610120578063170ab4051461015d57806318e7caf21461019a575b005b34801561010157600080fd5b5061010a6103fe565b604051610117919061131e565b60405180910390f35b34801561012c57600080fd5b5061014760048036036101429190810190610f7b565b61041d565b6040516101549190611303565b60405180910390f35b34801561016957600080fd5b50610184600480360361017f9190810190610f7b565b610483565b6040516101919190611303565b60405180910390f35b3480156101a657600080fd5b506101c160048036036101bc9190810190610fe0565b610686565b6040516101ce9190611303565b60405180910390f35b3480156101e357600080fd5b506101fe60048036036101f99190810190610fa4565b610854565b60405161020b9190611303565b60405180910390f35b34801561022057600080fd5b5061023b6004803603610236919081019061102f565b61086e565b6040516102489190611303565b60405180910390f35b34801561025d57600080fd5b50610266610907565b604051610273919061116f565b60405180910390f35b34801561028857600080fd5b5061029161095f565b60405161029e9190611154565b60405180910390f35b3480156102b357600080fd5b506102bc610984565b6040516102ca929190611191565b60405180910390f35b3480156102df57600080fd5b506102e8610a37565b6040516102f5919061131e565b60405180910390f35b34801561030a57600080fd5b50610313610a41565b6040516103249594939291906111c8565b60405180910390f35b34801561033957600080fd5b50610354600480360361034f9190810190610fe0565b610bfe565b6040516103619190611303565b60405180910390f35b34801561037657600080fd5b5061037f610c20565b6040516103949998979695949392919061123e565b60405180910390f35b6103a5610eee565b005b3480156103b357600080fd5b506103bc610f49565b6040516103c9919061131e565b60405180910390f35b3480156103de57600080fd5b506103e7610f56565b6040516103f5929190611339565b60405180910390f35b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b6000816104286103fe565b101561043357600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc839081150290604051600060405180830381858888f19350505050158015610479573d6000803e3d6000fd5b5060019050919050565b60005b81600480549050146104c457600460009080600181540180825580915050906001820390600052602060002001600090919290919091505550610486565b5b8160058054905014610503576005600090806001815401808255809150509060018203906000526020600020016000909192909190915055506104c5565b5b816006805490501461054257600660009080600181540180825580915050906001820390600052602060002001600090919290919091505550610504565b5b816007805490501461058157600760009080600181540180825580915050906001820390600052602060002001600090919290919091505550610543565b5b81600880549050146105c057600860009080600181540180825580915050906001820390600052602060002001600090919290919091505550610582565b5b81600980549050146105ff576009600090806001815401808255809150509060018203906000526020600020016000909192909190915055506105c1565b5b81600a805490501461063e57600a60009080600181540180825580915050906001820390600052602060002001600090919290919091505550610600565b5b81600b805490501461067d57600b6000908060018154018082558091505090600182039060005260206000200160009091929091909150555061063f565b60019050919050565b60006004600185038154811061069857fe5b906000526020600020016000815480929190600101919050555060018314156106ea57600560018503815481106106cb57fe5b90600052602060002001600081548092919060010191905055506107ca565b6002831415610722576006600185038154811061070357fe5b90600052602060002001600081548092919060010191905055506107c9565b600383141561075a576007600185038154811061073b57fe5b90600052602060002001600081548092919060010191905055506107c8565b6004831415610792576008600185038154811061077357fe5b90600052602060002001600081548092919060010191905055506107c7565b60058314156107c657600960018503815481106107ab57fe5b90600052602060002001600081548092919060010191905055505b5b5b5b5b600082141561080257600a60018503815481106107e357fe5b9060005260206000200160008154809291906001019190505550610837565b600182141561083657600b600185038154811061081b57fe5b90600052602060002001600081548092919060010191905055505b5b600160008154809291906001019190505550600190509392505050565b600082600281905550816003819055506001905092915050565b6000846002541115801561088457506003548511155b156108f957856108926103fe565b101561089d57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc879081150290604051600060405180830381858888f193505050501580156108e3573d6000803e3d6000fd5b506108ef828585610686565b50600190506108fe565b600090505b95945050505050565b6060600480548060200260200160405190810160405280929190818152602001828054801561095557602002820191906000526020600020905b815481526020019060010190808311610941575b5050505050905090565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b606080600a600b818054806020026020016040519081016040528092919081815260200182805480156109d657602002820191906000526020600020905b8154815260200190600101908083116109c2575b5050505050915080805480602002602001604051908101604052809291908181526020018280548015610a2857602002820191906000526020600020905b815481526020019060010190808311610a14575b50505050509050915091509091565b6000600154905090565b60608060608060606005600660076008600984805480602002602001604051908101604052809291908181526020018280548015610a9e57602002820191906000526020600020905b815481526020019060010190808311610a8a575b5050505050945083805480602002602001604051908101604052809291908181526020018280548015610af057602002820191906000526020600020905b815481526020019060010190808311610adc575b5050505050935082805480602002602001604051908101604052809291908181526020018280548015610b4257602002820191906000526020600020905b815481526020019060010190808311610b2e575b5050505050925081805480602002602001604051908101604052809291908181526020018280548015610b9457602002820191906000526020600020905b815481526020019060010190808311610b80575b5050505050915080805480602002602001604051908101604052809291908181526020018280548015610be657602002820191906000526020600020905b815481526020019060010190808311610bd2575b50505050509050945094509450945094509091929394565b6000610c0a8484610854565b50610c1482610483565b50600190509392505050565b6060806060806060806060806000600460056006600760086009600a600b60015488805480602002602001604051908101604052809291908181526020018280548015610c8c57602002820191906000526020600020905b815481526020019060010190808311610c78575b5050505050985087805480602002602001604051908101604052809291908181526020018280548015610cde57602002820191906000526020600020905b815481526020019060010190808311610cca575b5050505050975086805480602002602001604051908101604052809291908181526020018280548015610d3057602002820191906000526020600020905b815481526020019060010190808311610d1c575b5050505050965085805480602002602001604051908101604052809291908181526020018280548015610d8257602002820191906000526020600020905b815481526020019060010190808311610d6e575b5050505050955084805480602002602001604051908101604052809291908181526020018280548015610dd457602002820191906000526020600020905b815481526020019060010190808311610dc0575b5050505050945083805480602002602001604051908101604052809291908181526020018280548015610e2657602002820191906000526020600020905b815481526020019060010190808311610e12575b5050505050935082805480602002602001604051908101604052809291908181526020018280548015610e7857602002820191906000526020600020905b815481526020019060010190808311610e64575b5050505050925081805480602002602001604051908101604052809291908181526020018280548015610eca57602002820191906000526020600020905b815481526020019060010190808311610eb6575b50505050509150985098509850985098509850985098509850909192939495969798565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610f4757600080fd5b565b6000600480549050905090565b600080600254600354915091509091565b6000610f7382356113e0565b905092915050565b600060208284031215610f8d57600080fd5b6000610f9b84828501610f67565b91505092915050565b60008060408385031215610fb757600080fd5b6000610fc585828601610f67565b9250506020610fd685828601610f67565b9150509250929050565b600080600060608486031215610ff557600080fd5b600061100386828701610f67565b935050602061101486828701610f67565b925050604061102586828701610f67565b9150509250925092565b600080600080600060a0868803121561104757600080fd5b600061105588828901610f67565b955050602061106688828901610f67565b945050604061107788828901610f67565b935050606061108888828901610f67565b925050608061109988828901610f67565b9150509295509295909350565b60006110b28383611136565b60208301905092915050565b6110c781611398565b82525050565b60006110d88261136f565b6110e28185611387565b93506110ed83611362565b60005b8281101561111b576111038683516110a6565b955061110e8261137a565b91506001810190506110f0565b50849250505092915050565b611130816113aa565b82525050565b61113f816113d6565b82525050565b61114e816113d6565b82525050565b600060208201905061116960008301846110be565b92915050565b6000602082019050818103600083015261118981846110cd565b905092915050565b600060408201905081810360008301526111ab81856110cd565b905081810360208301526111bf81846110cd565b90509392505050565b600060a08201905081810360008301526111e281886110cd565b905081810360208301526111f681876110cd565b9050818103604083015261120a81866110cd565b9050818103606083015261121e81856110cd565b9050818103608083015261123281846110cd565b90509695505050505050565b6000610120820190508181036000830152611259818c6110cd565b9050818103602083015261126d818b6110cd565b90508181036040830152611281818a6110cd565b9050818103606083015261129581896110cd565b905081810360808301526112a981886110cd565b905081810360a08301526112bd81876110cd565b905081810360c08301526112d181866110cd565b905081810360e08301526112e581856110cd565b90506112f5610100830184611145565b9a9950505050505050505050565b60006020820190506113186000830184611127565b92915050565b60006020820190506113336000830184611145565b92915050565b600060408201905061134e6000830185611145565b61135b6020830184611145565b9392505050565b6000602082019050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b60006113a3826113b6565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600081905091905056fea265627a7a7230582063bcd303787f71f56a425cb0d64ce0432bc9208fb80ce8265cad0e99d5e4bb906c6578706572696d656e74616cf50037";
	
	
		
		// caver & 계정 로드
		Caver caver = Caver.build(Caver.BAOBAB_URL);
		KlayCredentials sender = KlayCredentials.create(sendUser);
		
		// SmartContracdeployTransaction 생성
		SmartContractDeployTransaction smartContractDeployTransaction = SmartContractDeployTransaction.create(
				sender.getAddress(), // 컨트렉트를 배포하고자 하는 계정의 주소
				BigInteger.ZERO, 
				Numeric.hexStringToByteArray(data), 
				new DefaultGasProvider().getGasLimit(), 
				BigInteger.ZERO);
		
		// sender의 계정으로 TransactionManager 인스턴스 생성
		TransactionManager txManager
			= new TransactionManager
				.Builder(caver, sender)
				.setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		String senderRawTransaction
			= txManager.sign(smartContractDeployTransaction, true).getValueAsString();
		
		KlayCredentials feePayer = KlayCredentials.create(feeUser);
		
		FeePayerManager feePayerManager
			= new FeePayerManager.Builder(caver,  feePayer)
				.setChainId(ChainId.BAOBAB_TESTNET).build();
		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(senderRawTransaction);
		
		String txHash = transactionReceipt.getTransactionHash(); 
		String deployedContractAddress = transactionReceipt.getContractAddress();
		String errorMessage = transactionReceipt.getErrorMessage();
		
		System.out.println("txHash : "+txHash);
		System.out.println("deployedContractAddress : " + deployedContractAddress);
		System.out.println("errorMessage : " + errorMessage);
	
		JSONObject result = new JSONObject();
		result.put("address",deployedContractAddress);
		return result;
	}


	public JSONObject klaytnSend3(String address, long time, int age, int gender, int select )throws Exception{ 
		Caver caver = Caver.build(Caver.BAOBAB_URL);

		KlayCredentials sender = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		//
//			byte[] byteArray=str.getBytes();
		
//			byte[] byteArray2 = "1212".getBytes();
//			String hexValue = javax.xml.bind.DatatypeConverter.printHexBinary(byteArray2);
		
		
		//Input byte array must be in range 0 < M <= 32 and length must match type 오류남.
		// 자바에선 16 비트 ? 로 바꿔서 길이가 63 ? 64 인데 , bytes32 에서는 길이를 32 까지 허용하니, 길이 오류가 남.
		
		// 파라메터 1 : 1: klay ? gass , 2: nowTime,   3:age, 4: gender, last: Seleted

		System.out.println("----------------------------------------send");
		Function function = new Function(
			RIROVote3.FUNC_TRANSFERWITHDATA,  // FUNC_TRANSFER = "transfer"
		        Arrays.asList(
		        		
						new Uint256(BigInteger.ZERO),
						new Uint256(time),
						new Uint256(age),
						new Uint256(gender),
						new Uint256(select)
						
		        		
		        		),  // inputParameters
		        Collections.emptyList()  // outputParameters          
		);
		String data = FunctionEncoder.encode(function);
		
		TransactionManager txManager = new TransactionManager.Builder(caver, sender)
                .setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		System.out.println("----------------------------------------send 1");

		SmartContractExecutionTransaction smartContractExecutionTransaction
			= SmartContractExecutionTransaction.create(
				sender.getAddress(),//만드는 User 의 address
				address,
		        BigInteger.ZERO,
		        Numeric.hexStringToByteArray(data),       
//			        sendData, //전송할 데이터
		        new DefaultGasProvider().getGasLimit(Test6.FUNC_TRANSFER)
//			        BigInteger.valueOf(100_000)
		);
		System.out.println("smartContractExecutionTransaction:" +smartContractExecutionTransaction);
		String rawTransaction
		        = txManager.sign(smartContractExecutionTransaction, true).getValueAsString();
				System.out.println("----------------------------------------send 2");
		KlayCredentials feePayer = KlayCredentials.create("0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2");// 수수료 부담하는 사람의 private key
		FeePayerManager feePayerManager
		        = new FeePayerManager.Builder(caver, feePayer)
		        		.build();
//			                .setChainId(ChainId.BAOBAB_TESTNET).build();
		//Sync : FeePayer ExecuteTx

		System.out.println("----------------------------------------send 3");

		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(rawTransaction);
		String errorMessage = transactionReceipt.getErrorMessage();
		String txHash = transactionReceipt.getTransactionHash();
		
		System.out.println("txHash: "+txHash);
		System.out.println("errorMessage : "+ errorMessage);

		System.out.println("----------------------------------------send 4");
		JSONObject json = new JSONObject();
		json.put("hash",txHash);
		return json;
	}
	
	
	public JSONObject klaytnSetOptions2(String address, long startTime, long endTime, int limit) throws Exception{
		Caver caver = Caver.build(Caver.BAOBAB_URL);

		KlayCredentials sender = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		//
//			byte[] byteArray=str.getBytes();
		
//			byte[] byteArray2 = "1212".getBytes();
//			String hexValue = javax.xml.bind.DatatypeConverter.printHexBinary(byteArray2);
		
		
		//Input byte array must be in range 0 < M <= 32 and length must match type 오류남.
		// 자바에선 16 비트 ? 로 바꿔서 길이가 63 ? 64 인데 , bytes32 에서는 길이를 32 까지 허용하니, 길이 오류가 남.
		
	//uint _startTime, uint _endTime, uint _limit, uint _state, uint _resultTime  
	// 1. 시작시간, 2. 마감시간, 3. 후보수, 
		Function function = new Function(
			RIROVote3.FUNC_SETOPTIONS,  // FUNC_TRANSFER = "transfer"
		        Arrays.asList(
		        		
		        		new Uint256(startTime),
						new Uint256(endTime),
						new Uint256(limit)
		        		
		        		),  // inputParameters
		        Collections.emptyList()  // outputParameters          
		);
		String data = FunctionEncoder.encode(function);
		
		TransactionManager txManager = new TransactionManager.Builder(caver, sender)
                .setChaindId(ChainId.BAOBAB_TESTNET).build();
		
		SmartContractExecutionTransaction smartContractExecutionTransaction
			= SmartContractExecutionTransaction.create(
				sender.getAddress(),//만드는 User 의 address
				address,
		        BigInteger.ZERO,
		        Numeric.hexStringToByteArray(data),       
//			        sendData, //전송할 데이터
		        new DefaultGasProvider().getGasLimit(Test6.FUNC_TRANSFER)
//			        BigInteger.valueOf(100_000)
		);
		System.out.println("smartContractExecutionTransaction:" +smartContractExecutionTransaction);
		String rawTransaction
		        = txManager.sign(smartContractExecutionTransaction, true).getValueAsString();
		
		KlayCredentials feePayer = KlayCredentials.create("0xe6dde3422998e00bbd13002e1396388d9b0e4f6ab3de630ce8167ff2c99057f2");// 수수료 부담하는 사람의 private key
		FeePayerManager feePayerManager
		        = new FeePayerManager.Builder(caver, feePayer)
		        		.build();
//			                .setChainId(ChainId.BAOBAB_TESTNET).build();
		//Sync : FeePayer ExecuteTx
		KlayTransactionReceipt.TransactionReceipt transactionReceipt 
			= feePayerManager.executeTransaction(rawTransaction);
			// transactionReceipt.get
		String errorMessage = transactionReceipt.getErrorMessage();
		String txHash = transactionReceipt.getTransactionHash();
		
		System.out.println("txHash: "+txHash);
		System.out.println("errorMessage : "+ errorMessage);

		JSONObject json = new JSONObject();
		json.put("hash",txHash);
		return json;
	}
	public JSONArray load3(String address) throws Exception{// 배포된 스마트 컨트렉트의 uint List 출력, count 출력 
		Caver caver = Caver.build(Caver.BAOBAB_URL);
		
		KlayCredentials credentials = KlayCredentials.create("0x26efd4a0c62543128ac05b4f3b29668d43c18a43531b5aecb85e387dd1dc0bd0");
		
//			0xcc1b2b7db95514cced8b7dcb169470eeda34ca76    -  대납
		RIROVote3 eeToken = RIROVote3.load(
//					"0x7b6c602b7e8dde60f16ec0684421d69868215f25",// 콘트렉트 adress 
//					"0x3970bec0c994b437d4bb2ccc277e965ce24f9ff6",
//					"0xb9be5c12aaf13a18e866883fccfa3327283d4891",
				// "0x3caef473574f6a9de0501d3073c5300e5a05ed1d",
				address,
				caver, 
				credentials, 
				ChainId.BAOBAB_TESTNET,
				new DefaultGasProvider());

		JSONArray json = new JSONArray();

		try{
			RemoteCall<Tuple9<List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, List<BigInteger>, BigInteger>> remoteCall 
			= eeToken.getListTotal();
			
		Tuple9<List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,List<BigInteger>,BigInteger> result = remoteCall.send();
		
		List<BigInteger> voteResult = result.getValue1();
		List<BigInteger> voteAge1 = result.getValue2();
		List<BigInteger> voteAge2 = result.getValue3();
		List<BigInteger> voteAge3 = result.getValue4();
		List<BigInteger> voteAge4 = result.getValue5();
		List<BigInteger> voteAge5 = result.getValue6();
		List<BigInteger> voteGender0 = result.getValue7();
		List<BigInteger> voteGender1 = result.getValue8();
		BigInteger count = result.getValue9();


		

		json.add(0, voteResult);


		JSONObject age = new JSONObject();

		for (int i=1; i<=voteResult.size(); i++){
			ArrayList data = new ArrayList();
			
			data.add(voteAge1.get(i-1));
			data.add(voteAge2.get(i-1));
			data.add(voteAge3.get(i-1));
			data.add(voteAge4.get(i-1));
			data.add(voteAge5.get(i-1));

			age.put(i,data);
		}
		json.add(1,age);

		JSONObject gender = new JSONObject();

		for (int i=0; i<voteResult.size(); i++){
			ArrayList data = new ArrayList();
			
			data.add(voteGender0.get(i));
			data.add(voteGender1.get(i));
			

			gender.put(i+1,data);
		}

		json.add(2,gender);
		json.add(3,count);




		}catch(Exception e){
			e.printStackTrace();
		}
			
		// json.put("count",eeToken.getCount().send());
		return json;
	}

}
// 

